class StoryReplayListView(generics.ListCreateAPIView):
    authentication_classes = [TokenJWTAuthentication]
    permission_classes = [permissions.IsAuthenticated]
    serializer_class = StoryReplaySerializer

    def get_queryset(self):
        queryset = StoryReplay.objects.all()
        queryset = queryset.order_by('-created_on')
        story_id = self.request.query_params.get('story_id')
        if story_id:
            queryset = queryset.filter(story_id=story_id)
        return queryset

    @swagger_auto_schema(
        operation_description="Retrieve story replies filtered by `story_id`.",
        manual_parameters=[openapi.Parameter(
            'story_id', openapi.IN_QUERY,
            description="Filter story replies by the ID of the associated story.",
            type=openapi.TYPE_INTEGER,
            required=False
        )],
        responses={200: StoryReplaySerializer(many=True), 401: "Unauthorized - You need to provide a valid token."}
    )
    def get(self, request, *args, **kwargs):
        return super().get(request, *args, **kwargs)

    @swagger_auto_schema(
        operation_description="Create a new reply for a story.",
        request_body=StoryReplayPostSerializer,
        responses={201: "Reply successfully created.", 400: "Bad Request - Invalid input data.", 401: "Unauthorized - You need to provide a valid token."}
    )
    def post(self, request, *args, **kwargs):
        user_id = get_user_id_from_token(request)
        if not user_id:
            return custom_error_response(message="Invalid token or user ID", status_code=status.HTTP_401_UNAUTHORIZED)

        warga = Warga.objects.filter(user=user_id).first()
        if not warga:
            return custom_error_response(message="Resident not found for the user", status_code=status.HTTP_404_NOT_FOUND)

        serializer = StoryReplayPostSerializer(
            data=request.data,
            context={'warga': warga, 'created_by': user_id}  # Pass context data
        )
        if serializer.is_valid():
            serializer.save()
            return custom_response(data=serializer.data)
        return custom_error_response(message=serializer.errors, status_code=status.HTTP_400_BAD_REQUEST)

   