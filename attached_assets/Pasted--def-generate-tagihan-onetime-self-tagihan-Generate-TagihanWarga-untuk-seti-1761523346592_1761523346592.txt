 def generate_tagihan_onetime(self, tagihan):
        """
        Generate TagihanWarga untuk setiap unit di residence.
        FIX: Menambahkan field warga (kepala keluarga) agar TagihanWarga muncul di list warga.
        """
        # Ambil semua unit di residence yang sama
        unit = MUnit.objects.filter(unit_residence=tagihan.residence).all()
        
        # Inisialisasi tagihan_ke
        tagihan_ke = tagihan.tagihan_ke if tagihan.tagihan_ke else 0
        
        # Loop untuk setiap unit
        for u in unit:
            # TAMBAHAN FIX: Cari kepala keluarga (warga lead) di unit ini
            warga_lead = Warga.objects.filter(
                unit_id=u, 
                is_lead=True,
                isactive=True
            ).first()
            
            # Jika tidak ada lead, ambil warga pertama yang aktif
            if not warga_lead:
                warga_lead = Warga.objects.filter(
                    unit_id=u,
                    isactive=True
                ).first()
            
            # Skip unit yang tidak ada warga aktif sama sekali
            if not warga_lead:
                continue
            
            # Generate nomor tagihan
            no_tagihan = "T-" + str(u.unit_id) + "-" + str(tagihan.id)
            
            # Tentukan tanggal jatuh tempo berdasarkan jenis tagihan
            date = tagihan.date_due
            if tagihan.jenis_tagihan == "monthly":
                date = tagihan.date_due + relativedelta(months=tagihan_ke)
            elif tagihan.jenis_tagihan == "yearly":
                date = tagihan.date_due + relativedelta(years=tagihan_ke)
            elif tagihan.jenis_tagihan == "weekly":
                date = tagihan.date_due + relativedelta(weeks=tagihan_ke)
            
            # Buat TagihanWarga
            TagihanWarga.objects.create(
                tagihan_id=tagihan.id,
                date_due=date,
                unit_id=u,
                warga=warga_lead,  # FIX: Field warga HARUS diisi!
                no_tagihan=no_tagihan,
                status="unpaid"
            )
        
        # Increment tagihan_ke
        tagihan_ke = tagihan_ke + 1
        
        return tagihan_ke

    def post(self, request, pk=None):
        try:
            tagihan = Tagihan.objects.get(id=pk)
--
    def generate_tagihan_onetime(self, tagihan):
        unit = MUnit.objects.filter(unit_residence=tagihan.residence).all()
        tagihan_ke = tagihan.tagihan_ke
        if tagihan_ke == None:
            tagihan_ke = 0
        for u in unit:
            no_tagihan = "T-" + str(u.unit_id) + "-" + str(tagihan.id)
            date = tagihan.date_due
            if tagihan.jenis_tagihan == "monthly":
                date = tagihan.date_due + relativedelta(months=tagihan_ke)
            elif tagihan.jenis_tagihan == "yearly":
                date = tagihan.date_due + relativedelta(years=tagihan_ke)
            elif tagihan.jenis_tagihan == "weekly":
                date = tagihan.date_due + relativedelta(weeks=tagihan_ke)
            TagihanWarga.objects.create(
                    tagihan_id=tagihan.id,
                    date_due=date,
                    unit_id=u,
                    no_tagihan=no_tagihan,
                    status="unpaid"
                )
        tagihan_ke = tagihan_ke+1

            
        return  tagihan_ke

    def post(self, request, pk=None):
        try:
            tagihan = Tagihan.objects.get(id=pk)
            tagihan.is_publish = True
            tagihan.publish_date = timezone.now()  # Set publish date to now
            tagihan.tagihan_ke =  self.generate_tagihan_onetime(tagihan)
            tagihan.save()
            serializer = TagihanSerializer(tagihan)
            return custom_response(serializer.data, status=200)
        except Tagihan.DoesNotExist:
            return custom_error_response('Tagihan tidak ditemukan', status_code=404)
     

class UnpublishTagihanView(APIView):
    permission_classes = [IsAuthenticated]
    authentication_classes = [TokenJWTAuthentication]

    @swagger_auto_schema(
        manual_parameters=[
            openapi.Parameter(
                'tagihan_id',
                openapi.IN_PATH,
                description="ID Tagihan untuk filter catatan",
                type=openapi.TYPE_INTEGER
            )
        ],
        responses={200: NoteUnpublishTagihanSerializer(many=True)}
    )
    def get(self, request, tagihan_id):
        tagihan_notes = TagihanUnpublishNote.objects.filter(tagihan=tagihan_id)
        serializer = NoteUnpublishTagihanSerializer(tagihan_notes, many=True)
        return custom_response(serializer.data, status=status.HTTP_200_OK)

    @swagger_auto_schema(
        manual_parameters=[